<html>
<head>
    <title>{{title}}</title>


    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/treemap.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/barchart.css">
    <link rel="stylesheet" type="text/css" href="/libraries/jquery-ui-1.11.0.custom/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/libraries/bootstrap-3.2.0-dist/css/bootstrap.min.css">    
    <link rel="stylesheet" type="text/css" href="/libraries/bootstro/bootstro.min.css">

    <script type="text/javascript" src="/libraries/colorbrewer.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="/libraries/jquery-ui-1.11.0.custom/jquery-ui.min.js"></script> 
    
    <script type="text/javascript" src="/libraries/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>    
    <script type="text/javascript" src="/libraries/bootstrap-typeahead/bootstrap3-typeahead.min.js"></script>
    <script type="text/javascript" src="/libraries/bootstro/bootstro.min.js"></script>

    <!--<script type="text/javascript" src="/javascripts/issue.js"></script>-->
    <script type="text/javascript" src="/javascripts/treemap.js"></script>
    <script type="text/javascript" src="/javascripts/barchart.js"></script>
    
    <script type="text/javascript">
        var user = null;
        var selected_service = null, previous_service = null;
        var selected_issue  = null;
        var issues = null, all_issues = null, budgets = null, all_services = null, services = null;
        var curr_year = 2014;
        var treemap = null, barchart = null;
        var service_map = {}, issue_map = {}, budget_map = {}, service_list_map = {};
        var em_services = null;
        var em_budgets  = null;
        var barchart_config = {
            container : "#service-chart",
            size :  { width: 250, height: 750},
            margin: {top: 0, right: 0, bottom: 0, left: 0},
            onSelect: selectService,
            onDeselect: deselectService,
            onMouseOver: overService,
            onMouseOut: outService
        };
        var treemap_config = {
            container : "#budget-chart",
            size :  { width: 550, height: 700},
            margin : { top: 0, left: 0, bottom: 0, right: 0},
            onSelect: selectBudget,
            onDeselect: deselectBudget
        }
        $(document).ready(function(){
            
            $("#progress-modal").modal({
                keyboard: false,
                backdrop: "static"
            });
            var issueLoaded     = false;
            var budgetLoaded    = false;
            var inc = 0;
            var progress = setInterval(function(){ //Trick Progress
                inc += inc>=100? 0:Math.floor((Math.random() * 10) + 1);;
                 $("#progress-bar").css('width', inc+'%').attr('aria-valuenow', inc); 
                if (issueLoaded && budgetLoaded){
                    $("#progress-bar").css('width', "100%").attr('aria-valuenow', 100); 
                    clearInterval(progress); 
                    $("#progress-modal").modal("hide");
                    generateGuide();
                } 
            }, 1000);

            $.getJSON('/budgets', function(data){
                budgetLoaded = true;
                //console.log(data.budget);
                budgets         = data.budget;
                console.log(data.budget);
                for (var i in budgets.children){//top level
                    for (var j in budgets.children[i].children){
                        budget_map[budgets.children[i].children[j].name] = budgets.children[i].children[j];
                    }
                }
                //console.log(budget_map);
                all_services        = [];
                service_list_map    = data.services;
                for (var name in service_list_map){ //construct service map
                    for (var i in service_list_map[name]){
                         service_map[service_list_map[name][i]._id] = service_list_map[name][i];
                         all_services.push(service_list_map[name][i]);
                        /*if (service_list_map[name][i].issues && service_list_map[name][i].issues.length>0){
                             $.post("budgets/"+service_list_map[name][i]._id,
                            {
                                issues: []
                            });
                        }*/
                    }                   
                }
                all_services.sort(function(a, b){
                    return b.budget_assigned - a.budget_assigned;
                });
                //create budget chart
                treemap_config.data = budgets;
                treemap = TreeMap(treemap_config);
                treemap.create();
                //treemap.selectMax();

                //create service chart
                barchart_config.data = services = all_services;
                barchart = BarChart(barchart_config);
                barchart.create(); 

                //Load Issues
                $.getJSON('/issues', function(data){
                    issueLoaded = true;
                    all_issues = issues = data;
                    console.log(all_issues);
                    for (var i in all_issues){//construct issue map
                        console.log(all_issues[i]);
                        issue_map[all_issues[i]._id] = all_issues[i];
                        //calculate total budget
                        var total = 0;
                        for (var j in all_issues[i].budgets){                        
                            total += service_map[all_issues[i].budgets[j]].budget_assigned;
                        }
                        issue_map[all_issues[i]._id].budget_assigned = total;
                        
                    }
                    displayIssues(data);

                    initialize();
                });

            });
            $('#left-content').resize(function(){
                var elem = $(this);
                console.log('w, h = ' + elem.width() + ', ' + elem.height());
            });
            $('#new-issue').keypress(function(event) { return event.keyCode != 13; });
            $('#issue-modal-confirm').click(addIssue);
            $('#service-modal-confirm').click(connectIssue);
            $('#service-modal-cancel').click(function (){ selected_service = previous_service; });
            $('#btn-new-issue').click(populateIssueModal);
            $('#btn-service-search').click(searchService);
            $('#delete-modal-confirm').click(deleteIssue);
            $('#signin').click(function(){
                if (user){
                    $.post("/logout", {
                        user: user
                    }, function(res){
                        alert(user.nickname + " : 로그아웃 되었습니다.")
                        user = null;
                        $("#signin").text("Sign In");
                        $("#nickname").text("");
                    }); 
                }else{
                    $('#auth-modal').modal("show");    
                }
                
            });
            $('#btn-signin').click(signin);
            $('#btn-register').click(register);

            $('#service-search').keydown(function(event){    
                if(event.keyCode==13){
                   $('#btn-service-search').trigger('click');
                }
            });
            $("#service-more-info").click(function() {
                var url = constructSearchUrl($("#selected_service").text());
                window.open(url, '_blank');
            });

            $("#service-search-cancel").click(function(){
                $('#service-search').val("");
                $('#service-search-result').hide();
                barchart.update(services, barchart_config.width, barchart_config.height)
            })
        });

        // $(window).resize(function(){
        //     var elem = $(this);
        //     console.log('w, h = ' + elem.width() + ', ' + elem.height());
        // });
        function initialize(){
            deselectService(null);
            deselectBudget(null);
        }
        function generateGuide(){
            $("#budget-area").addClass("bootstro")
                .attr("data-bootstro-title", "서울시 예산 지도")
                .attr("data-bootstro-content", "예산 분야를 선택하면 사업목록의 범위를 좁힐 수 있습니다. 상단의 범례를 클릭하면 해당 분야만 확대해서 보기가 가능합니다.")
                .attr("data-bootstro-placement", "right")

            $("#service-area").addClass("bootstro")
                .attr("data-bootstro-title", "서울시 사업 목록")
                .attr("data-bootstro-content", "사업항목을 선택하면 관련된 사회이슈 목록을 확인 및 추가 할 수 있습니다. 원하는 사업을 검색할 수 있으며, 이슈가 선택되었을 시 해당하는 사업만 하이라이트 됩니다.")
                .attr("data-bootstro-placement", "left")

            $("#issue-area").addClass("bootstro")
                .attr("data-bootstro-title", "사업 정보")
                .attr("data-bootstro-content", "선택한 사업에 대한 정보와 연관된 이슈를 확인 할 수 있다. 이슈를 선택하면 해당하는 예산 분야와 사업들을 탐색 할 수 있다.")
                .attr("data-bootstro-placement", "left")
            bootstro.start();
        }
        function constructSearchUrl(name){
                return 'http://opengov.seoul.go.kr/search?sortField=RANK&page=0&searchTarget=section&viewCount=100&isDetailSearch=0&isInitKeyword=0&depth=1&isAll=1&s-category=section&searchKeyword='
                + name + '&srcField%5B%5D=ALL&srcField%5B%5D=TITLE&srcField%5B%5D=CONTENT&srcField%5B%5D=DEPT_NM%2CWRITER&srcField%5B%5D=KWRD&srcField%5B%5D=ATTACH_NM&option=reSearch';
        }
        function signin(){
            var email = $('#signin-form :input[name="signinEmail"]').val();
            var password = $('#signin-form :input[name="signinPassword"]').val();

            if (email == "" || password ==""){
                $("#signin-fail").text("이메일 혹은 패스워드가 입력되지 않았습니다.").show().effect( "shake" ).delay(2000).fadeOut();
                return;
            }
            $.post("/signin", 
            {
                email: email,
                password: password
            }, function(res){
                if (res.code>0){
                    $("#signin-fail").text(res.message).show().effect( "shake" ).delay(2000).fadeOut();
                    return;
                }
                user = res.user;
                $('#signin-form :input[name="signinEmail"]').val("");
                $('#signin-form :input[name="signinPassword"]').val("");
                $("#signin").text("Logout");
                $("#nickname").text(user.nickname);
                $("#auth-modal").modal("hide");
            }); 
        }
        function register(){
            var email = $('#register-form :input[name="registerEmail"]').val();
            var nickname = $('#register-form :input[name="registerNickname"]').val();
            var password = $('#register-form :input[name="registerPassword"]').val();

            if (email == "" || nickname=="" || password ==""){
                $("#register-fail").text("입력되지 않은 필드가 있습니다.").show().effect( "shake" ).delay(2000).fadeOut();
                return;
            }
            $.post("/register", 
            {
                email: email,
                nickname: nickname,
                password: password
            }, function(res){
                if (res.code>0){
                    $("#register-fail").text(res.message).show().effect( "shake" ).delay(2000).fadeOut();
                    return;
                }             
                $('#register-form :input[name="registerEmail"]').val("");
                $('#register-form :input[name="registerNickname"]').val("");
                $('#register-form :input[name="registerPassword"]').val("");
                $("#register-success").text(" 성공적으로 가입되었습니다. 로그인을 해주세요.").show().delay(2000).fadeOut();  
                //$("#signin").text(res.user.nickname);
                //$("#auth-modal").modal("hide");
            });  
        }
        function selectBudget(d){
            if (services==service_list_map[d.name]) return;
            //fillter services by the selected budget
            services = service_list_map[d.name];

            // set up service chart panel
            $("#service-chart").scrollTop(0);
            //$("#service-chart").empty();
            $("#service-chart-title").text(d.name+" 관련 사업목록("+services.length+"개)");
            $("#service-search-group").show(); 
            $("#service-search-result").hide();   

            //draw barchart
            barchart.update(services, barchart_config.width, barchart_config.height);
            
            //show issue counts on top
            if (selected_issue!=null){
                 //setTimeout(function(){
                    barchart.emphasize(em_services);  
                    var id = selected_issue.attr('data-issue-id');
                    var issue = issue_map[id];
                    $("#issue-service-result").show();
                    $("#issue-service-text").text(issue.name+"이슈 관련 사업: "+barchart.emphasize().length+"개");
                //}, 750);
             
            }
            if (selected_service && services.indexOf(selected_service)==-1){
                deselectService(null);
            }
            //maintain previously selected service, if possible
            //if (selected_service && services.indexOf(selected_service)!=-1){
            //    selectService(d);
            //}else{            
            //    deselectService(null); //de-select previously selected service
            //}
            //if (em_budgets && em_budgets.indexOf(d)==-1){
            //    deselectIssue();
            //}
        }
        
        function deselectBudget(d){
            //deselectService(null);

            //set to all services
            services = all_services;

            // set up service chart panel
            $("#service-chart").scrollTop(0);
            //$("#service-chart").empty();
            $("#service-chart-title").text("서울시 사업목록("+services.length+"개)");
            $("#service-search-group").show(); 
            $("#service-search-result").hide();   

            //draw barchart
            barchart.update(services, barchart_config.width, barchart_config.height);

            //show issue counts on top
            if (selected_issue!=null){
                //setTimeout(function(){

                    barchart.emphasize(em_services);  
                    var id = selected_issue.attr('data-issue-id');
                    var issue = issue_map[id];
                    $("#issue-service-result").show();
                    $("#issue-service-text").text(issue.name+"이슈 관련 사업: "+barchart.emphasize().length+"개");
                //}, 750);
            }    


            //maintain previously selected service, if possible
            //if (selected_service && services.indexOf(selected_service)!=-1){
            //    selectService(d);
            //}else{            
            //    deselectService(null); //de-select previously selected service
            //}    
        }
        function serviceName(service){
            return service.service;//service.service.split(".")[1];
        }
        function populateIssueModal(){
            var service = selected_service; 
            //populate issue modal box
            console.log(service)
            var items = [];
            if (service!=null){
                $("#issue-modal-info").html("<h4>" + serviceName(service) + " <small>사업 관련된 사회이슈를 입력해 주세요.</small></h4>");
                for (var i in all_issues){
                    var exist = false;
                    for (var j in issues){
                        if (issues[j]._id == all_issues[i]._id){
                            exist = true;
                            break;
                        }                        
                    }
                    if (exist==false)   items.push(all_issues[i]); 
                }
            }else{
                $("#issue-modal-info").html("<h4>2014년 서울시 전체 예산<small>과 관련된 사회이슈를 입력해 주세요.</small></h4>");
            }
            console.log(items);
            updateAutocomplete(items);
            $("#new-issue").val("");
            $("#issue-modal").modal("show");
            
        }
        function populateServiceModal(issue_name, service){
            $("#service-modal-info").html(
                "<h4>"+serviceName(service)+"<small> 사업 관련 사회이슈에 </small></h4>" + 
                "<h4>"+issue_name+"<small> 이슈를 추가합니다. </small></h4><hr>"+
                "<h4>"+serviceName(service)+"</h4>"+
                "<table><tbody>"+
                "<tr><td>대분류 </td><td>: "+service.category_one+"</td></tr>" +
                "<tr><td>소분류 </td><td>: "+service.category_three+"</td></tr>" +
                "<tr><td>회계년도 </td><td>: "+service.year+"</td></tr>" +
                "<tr><td>부서 </td><td>: "+service.department+"</td></tr>" +
                "<tr><td>그룹 </td><td>: "+service.team+"</td></tr>" +
                "<tr><td>예산 </td><td>: "+treemap.format(service.budget_assigned)+"</td></tr>" +
                "</tbody></table>" +
                "<a id='service-more-info' class='text-right' target='_blank' href='"+
                constructSearchUrl(serviceName(service))+"'>사업 더 알아보기 ...</a>");
            $("#service-modal").modal("show");
        }
        function overService(d){
            if (services == all_services)   treemap.emphasize([budget_map[d.category_three]]);
        }
        function outService(d){
            if (selected_issue){
                treemap.emphasize(em_budgets);    
            }else{
                treemap.deemphasize();
            }
            
        }
        function selectService(d){
            previous_service = selected_service;
            selected_service = d;
            
            if (em_services && em_services.indexOf(d)==-1){ //if issue is selected but not connected yet
                //deselectIssue();
                populateServiceModal(issue_map[selected_issue.attr("data-issue-id")].name, d);
                return false;
            } //else if issue is selected and also connected to this service                    

             //update right info-panel
            $('#issue-title').text(serviceName(d));
            $('#service-info').html("<h4>"+serviceName(d)+"</h4>"+
                "<table><tbody>"+
                "<tr><td>대분류 </td><td>: "+d.category_one+"</td></tr>" +
                "<tr><td>소분류 </td><td>: "+d.category_three+"</td></tr>" +
                "<tr><td>회계년도 </td><td>: "+d.year+"</td></tr>" +
                "<tr><td>부서 </td><td>: "+d.department+"</td></tr>" +
                "<tr><td>그룹 </td><td>: "+d.team+"</td></tr>" +
                "<tr><td>예산 </td><td>: "+treemap.format(d.budget_assigned)+"</td></tr>" +
                "</tbody></table>");
            issues = [];
            for (var i in d.issues){
                issues.push(issue_map[d.issues[i]]);
            }
            displayIssues(issues);        
            $("#service-more-info").show();
            return true;        
        }

        function deselectService(d){
            selected_service = null;
            $('#issue-title').text("2014년 서울시 전체 예산");  
            $('#service-info').html("<h4>2014년 서울시 전체 예산</h4>"+
                    "<table><tbody>"+
                    "<tr><td>총 사업개수 </td><td>: "+budgets.serv_size+"</td></tr>" +
                    "<tr><td>총 예산 </td><td>: "+treemap.format(budgets.size)+"</td></tr>" +
                    "</tbody></table>");
            console.log(all_issues);
            issues = all_issues;  
            displayIssues(issues); 
            $("#service-more-info").hide();
            return true;
        }
        function connectIssue(){

            //emphasize list update
            em_services.push(selected_service);
            em_budgets.push(budget_map[selected_service.category_three]);

            //select
            barchart.select(selected_service);

            //emphasize
            barchart.emphasize(em_services);
            treemap.emphasize(em_budgets);

            //add issue
            var issue = issue_map[selected_issue.attr("data-issue-id")];
            $('#new-issue').val(issue.name); //set input box manually
            addIssue();

            //setTimeout(function(){
            $("#issue-service-result").show();
            $("#issue-service-text").text(issue.name+" 관련 사업: "+barchart.emphasize().length+"개");
            //}, 100);

            $("#service-modal").modal("hide");

        }
        function addIssue(){
            var issue_name = $('#new-issue').val();

           if (issue_name==""){//no issue name provided
                console.log("no issue name provided")
                $( "#new-issue-fail" ).text("이슈가 입력되지 않았습니다.").show().effect( "shake" ).delay(2000).fadeOut();
                return;
            }

            var issue = null;
            for (var i in all_issues){
                if (all_issues[i].name == issue_name){
                    issue = all_issues[i];
                    break;
                }
            }

            if (issue!=null){ //update an existing issue
                //console.log(selected_service);
                if (selected_service==null || selected_service.issues.indexOf(issue._id)!=-1){
                    $( "#new-issue-fail" ).text("이미 등록된 이슈가 있습니다.").show().effect( "shake" ).delay(2000).fadeOut();
                    return;
                }else{
                    //update issues
                    issue.budgets.push(selected_service._id);
                    issue.budget_assigned += selected_service==null? 0:selected_service.budget_assigned;
                    issues.push(issue);
                    createIssueElem(issue, "front").effect("highlight", {color: '#428bca'}, 2000);
                    updateIssueTitle();

                    $.post("/issues/"+issue._id, 
                        {
                            budgets: issue.budgets
                        }); 
                    //update service
                    selected_service.issues.push(issue._id)
                    treemap.increaseIssueCnt(selected_service.category_three);//update treemap issue count

                    //console.log(selected_service.issues);
                    $.post("budgets/"+selected_service._id,
                        {
                            issues: selected_service.issues
                        });
                }                    
            }else{//create a new issue
                $.post("/issues", {
                    name: issue_name,
                    year: curr_year,
                    budgets: selected_service==null? []:[selected_service._id]
                }, function(res){   
                    issue = res.result[0];    
                    issue.budget_assigned = 0;
                    issue.budget_assigned += selected_service==null? 0:selected_service.budget_assigned;  

                    //update issue lists
                    issues.push(issue); 
                    if (issues!=all_issues) all_issues.push(issue);
                    //console.log(all_issues);
                    issue_map[issue._id] = issue;
                    createIssueElem(issue, "front").effect("highlight", {color: '#428bca'}, 2000);
                    updateIssueTitle();

                    
                    if (selected_service!=null){//connect with budget on issue-creation
                        selected_service.issues.push(issue._id);
                        treemap.increaseIssueCnt(selected_service.category_three);//update treemap issue count
                        $.post("budgets/"+selected_service._id, {
                            issues: selected_service.issues
                        })
                    }
                })

            }
            $('#new-issue').val(""); 
            $( "#new-issue-success" ).text(issue_name+" 이슈가 성공적으로 등록되었습니다.").show().delay(2000).fadeOut();       
            $("#issue-modal").modal("hide");
        }
        function updateAutocomplete(issues){
            var source = [];
            for (var i in issues){
                source.push(issues[i].name);
            }
            $('#new-issue').typeahead('destroy')
            $('#new-issue').typeahead({source: source, highlight: true});
        }
        function updateIssueTitle(){
            selected_service==null? $('#issue-list-title').text("전체 사회이슈("+(all_issues? all_issues.length : 0)+"개)") 
                : $('#issue-list-title').text("연관 사회이슈("+(issues? issues.length : 0) +"개)");
        }
        function displayIssues(data){
            if (data==null) return;
            updateIssueTitle();
            
            $('#issue-list').empty();
            for (var i in data){
                createIssueElem(data[i], "end");
            }
        }
        function deleteIssue(){
            console.log("removoing: "+ $("#delete-modal-info").attr("data-issue-id"));
            var issue = issue_map[$("#delete-modal-info").attr("data-issue-id")];
            if (selected_issue && issue_map[selected_issue.attr("data-issue-id")]==issue){
                deselectIssue();
            }

            if (selected_service!=null){
                var selVal = $(':radio[name="delete-issue"]:checked').val();
                console.log(selVal);
                if (selVal=="disconnect"){ //delete only the connection
                    //remove connection
                    selected_service.issues.splice(selected_service.issues.indexOf(issue._id), 1);
                    issues.splice(issues.indexOf(issue), 1);
                    issue.budgets.splice(issue.budgets.indexOf(selected_service._id), 1);
                    $.post("issues/"+issue._id,
                    {
                        budgets: issue.budgets
                    });
                    $.post("budgets/"+selected_service._id,
                    {
                        issues: selected_service.issues
                    });
                    //remove issue displayed
                    $('a[data-issue-id="'+issue._id+'"').fadeOut().remove();
                    //update treemap issue count
                    budget_map[selected_service.category_three].issue_size-=1;
                    treemap.updateIssueCnt();
                    updateIssueTitle();
                    $("#delete-modal").modal("hide");
                    return;
                }
            }

            //remove issue completely
            $.ajax({
                url: '/issues/'+issue._id,
                type: 'DELETE',
                fail: function(result) {
                    alert("failed to delete issue!")
                }
            });
            //update front-end issue
            delete issue_map[issue._id];
            var idx = issues.indexOf(issue);
            console.log(idx);
            if (idx!=-1)  issues.splice(idx, 1);
            idx = all_issues.indexOf(issue);
            console.log(idx);
            if (idx!=-1) all_issues.splice(idx, 1);

            //remove issue displayed
            $('a[data-issue-id="'+issue._id+'"').fadeOut().remove();

            //remove connections
            for (var i in issue.budgets){
                var service = service_map[issue.budgets[i]];

                //update issue-service connection
                service.issues.splice(service.issues.indexOf(issue._id), 1);
                budget_map[service.category_three].issue_size-=1;
                $.post("budgets/"+service._id,
                {
                    issues: service.issues
                });
            }
            //update treemap issue count
            treemap.updateIssueCnt();

            updateIssueTitle();

            $("#delete-modal").modal("hide");
        }
        function createIssueElem(issue, pos){
            //console.log(issue)
            var newElem = $('<a href="javaScript:void(0);" class="list-group-item issue-item"><strong>'+issue.name+'</strong><span class="delete-issue-item text-primary" style="display:none"> (삭제)</span><span class="badge">관련사업: '+issue.budgets.length+'개</span><br><span class="text-muted">예산 총액: '+(issue.budget_assigned==0? "0원": treemap.format(issue.budget_assigned))+'</span></a>');// data-issue-id="'+issue._id+'"

            if (pos=="end"){
                newElem.appendTo('#issue-list');
            }else{
                newElem.prependTo('#issue-list');
            }
            newElem.find(".delete-issue-item")
                .hover(function(){
                    $(this).css('text-decoration', 'underline');
                }, function(){
                    $(this).css('text-decoration', 'none');
                })
                .click(function(e){
                    e.stopPropagation();
                    $("#delete-modal-info").attr("data-issue-id", issue._id);
                    if (selected_service!=null){
                        $("#delete-modal-info").html("<h4>"+serviceName(selected_service)+"<small> 사업에서 </small></h4><h4>"+issue.name+"<small> 이슈를 삭제합니다.</small></h4>");
                        $("#delete-modal-form").show();
                    }else{
                        $("#delete-modal-info").html("<h4>"+issue.name+"<small> 이슈를 삭제합니다. </small></h4><br/>* 연관된 모든 사업에서 해당 이슈가 사라집니다.");
                        $("#delete-modal-form").hide();
                    }
                  
                    $("#delete-modal").modal("show");
                })
            /*
            var elem = null
            newElem.mouseover(function(e){
                e.stopPropagation();
                console.log("issue-item-over");
                elem = $("").appendTo($(this));
                
                elem.mouseover(function(e){ e.stopPropagation(); })
                elem.mouseout(function(e){ e.stopPropagation(); })
                elem.click(function(e){ 
                    e.stopPropagation();
                    alert("삭제");
                }) 
            });
            newElem.mouseout(function(e){
                e.stopPropagation();
                $(elem).remove();
            });
            */
            newElem.attr('data-issue-id', issue._id);
            if (selected_issue!=null && issue._id == selected_issue.attr("data-issue-id")){
                selected_issue = newElem;
                selected_issue.addClass("list-group-item-info");
            }
            newElem.hover(function(){
                    newElem.find(".delete-issue-item").show();
                }, function(){
                    newElem.find(".delete-issue-item").hide();
                })
                .click(selectIssue);
            return newElem;
        }
        function deselectIssue(){
            if (selected_issue==null) return;
            selected_issue.removeClass("list-group-item-info");
            treemap.deemphasize();
            if (barchart!=null)   barchart.deemphasize();
            selected_issue = null;
            em_budgets = null;
            em_services = null;
            $("#issue-service-result").hide();
            $("#issue-service-text").text("");

        }
        function selectIssue(){
            if (selected_issue!=null){    
                console.log("deselect");            
                if (selected_issue.get(0)==this){ 
                    deselectIssue();                    
                    return;
                } 
                deselectIssue(); 
            }
            console.log("select");
            selected_issue = $(this);           

            //find issue
            var id = selected_issue.attr('data-issue-id');
            var issue = issue_map[id];

            //find budgetes             
            em_budgets = [];
            em_services = [];
            var exists = {};
            for (var i in issue.budgets){
                var serv = service_map[issue.budgets[i]];
                if (exists[serv.category_three]== null){
                    exists[serv.category_three] = 1;
                    em_budgets.push(budget_map[serv.category_three]);
                }
                em_services.push(serv);
                //if (services.indexOf(serv)!= -1){
                //    em_services.push(serv);
                //} 
            }
            console.log(em_budgets);
            console.log(em_services);
            selected_issue.addClass("list-group-item-info"); 
            treemap.emphasize(em_budgets);
            if (barchart!=null)   barchart.emphasize(em_services);
            $("#issue-service-result").show();
            $("#issue-service-text").text(issue.name+"이슈 관련 사업: "+barchart.emphasize().length+"개");
        }

        function searchService(){
            if (services==null) return;
            var query =  $('#service-search').val(); 
            var filtered = [];
            for (var i in services){
                var service = services[i];
                if (service.service.search(query)!=-1){
                    filtered.push(service);
                }
            }
            // if there is no selected servce in the search results, deselect it
            if (filtered.indexOf(selected_service)==-1){
                deselectService(null);
            }
            barchart.update(filtered, barchart_config.width, barchart_config.height);
            //alert(filtered.length+"개 찾음: "+ test);
            //$('#service-search').val(""); 
            $('#service-search-text').text(filtered.length + " 개 사업이 검색됨");
            $('#service-search-result').show();

            //update # of services associated with the selected issue if necessary
            if (selected_issue!=null){
                var id = selected_issue.attr('data-issue-id');
                var issue = issue_map[id];
                $("#issue-service-result").show();
                $("#issue-service-text").text(issue.name+"이슈 관련 사업: "+barchart.emphasize().length+"개");
            }
        }
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">BudgetMap</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/explore">Explore Task</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a id="nickname" href="javaScript:void(0);"></a>
                    </li>
                    <li>
                        <a id="signin" href="javaScript:void(0);">Sign In</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>    
    <div class="container">
        <div class="row">
            <!-- VISUALIZATION -->
            <div class="col-md-9">
                <div class="row">
                    <div id="budget-area" class="col-md-8">
                        <h4 class="page-header" style="margin-top:0px;">서울시 예산 지도(2014)
                            <small> 서울시 사업 예산과 관련된 이슈를 공유해 보세요!</small>
                        </h4>
                        <div id="budget-chart" style="float:left"></div>
                    </div>
                    <div id="service-area" class="col-md-4" style="padding-left:0px;">
                        <h4 id="service-chart-title" style="margin:0px;"></h4> 
                        <div id="service-search-group" class="input-group" style="display:none">
                            <input id="service-search" type="text" class="form-control" placeholder="사업명을 입력하세요.">
                            <span class="input-group-btn">
                                <button id="btn-service-search" class="btn btn-default" type="button">검색</button>
                            </span>
                        </div>
                        <div id="service-search-result" style="display:none; padding: 5px; margin-bottom:5px;" class="alert alert-success" role="alert">
                          <button id="service-search-cancel" type="button" class="close"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                          <p id="service-search-text"></p>
                        </div>
                        <blockquote id="issue-service-result" style="display:none; margin:5px; 0px;">
                            <h5 id="issue-service-text" class="text-muted"></h5>
                        </blockquote>
                        <div id="service-chart" style="width:280px;height:700px;overflow: auto;"></div>
                    </div>  
                </div>
            </div>             
            <!-- ISSUE AREA -->
            <div class="col-md-3">
                <div id="issue-area" class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 id="issue-title" class="panel-title">2014년 서울시 전체 예산</h3>
                    </div>
                    <div class="panel-body">                        
                        <div id="service-info"></div>
                        <a id="service-more-info" class="text-right" href="#" style="display:none">사업 더 알아보기 ...</a>
                    </div>
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <button id="btn-new-issue" type="button" class="btn btn-info">
                                <span class="glyphicon glyphicon-plus"></span>  이슈 더하기
                            </button> 
                         </div>
                    </div>
                    <h4 id="issue-list-title" class="page-header text-muted text-center" style="margin:10px 0px;">
                    </h4>   
                    <div id="issue-list" class="list-group">
                    </div>
                    <!--<div class="text-center">
                        <ul class="pagination">
                            <li class="disabled"><a href="#">&laquo;</a></li>
                            <li class="active"><a href="#">1</a></li>
                            <li><a href="#">2</a></li>
                            <li><a href="#">3</a></li>
                            <li><a href="#">4</a></li>
                            <li><a href="#">5</a></li>
                            <li><a href="#">&raquo;</a></li>
                        </ul> 
                    </div>-->
                </div> 
            </div>
        </div>
    </div>
    <!--Progressbar Modal -->
<!-- Modal -->


<!-- Progress Modal -->
<div class="modal fade" id="progress-modal" tabindex="-1" role="dialog" aria-labelledby="progress-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="progress-modal-label">서울시 예산 정보를 로딩 중입니다...</h4>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                    </div>
                </div>  
            </div>
        </div>
    </div>
</div>
<!-- New Issue Modal -->
<div class="modal fade" id="issue-modal" tabindex="-1" role="dialog" aria-labelledby="issueModelLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 id="issue-modal-title" class="modal-title" id="issueModelLabel">새로운 이슈 더하기</h4>
        </div>
        <div class="modal-body">
            <p id="issue-modal-info"></p> 
            <div id="new-issue-form">
                <div class="input-group"  style="width:100%">
                    <input id="new-issue" data-provide="typeahead" type="text" class="form-control" placeholder="사회이슈를 입력 해주세요..." style="width:100%" autocomplete="off">
                </div>                                
                <div id="new-issue-fail" class="alert alert-danger" role="alert" style="display:none">이슈를 올바르게 입력해주세요.</div>
                <div id="new-issue-success" class="alert alert-success" role="alert" style="display:none">이슈를 추가하였습니다.</div>
                <br/>
            </div>
                                  
                       
        </div>
        <div class="modal-footer">
            <button id="issue-modal-cancel" type="button" class="btn btn-default" data-dismiss="modal">취소</button>
            <button id="issue-modal-confirm" type="button" class="btn btn-primary">확인</button>
            </div>
        </div>
    </div>
</div>  
<div class="modal fade" id="service-modal" tabindex="-1" role="dialog" aria-labelledby="serviceModelLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 id="service-modal-title" class="modal-title" id="serviceModelLabel">새로운 이슈 더하기</h4>
        </div>
        <div class="modal-body">
            <p id="service-modal-info"></p> 
        </div>
        <div class="modal-footer">
            <button id="service-modal-cancel" type="button" class="btn btn-default" data-dismiss="modal">취소</button>
            <button id="service-modal-confirm" type="button" class="btn btn-primary">확인</button>
            </div>
        </div>
    </div>
</div>  
<div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="deleteModelLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 id="delete-modal-title" class="modal-title" id="deleteModelLabel">이슈 삭제하기</h4>
            </div>
            <div class="modal-body">
                <p id="delete-modal-info"></p> 
                <form id="delete-modal-form" style="display:none">
                    <input id="delete-modal-select1" type="radio" name="delete-issue" value="disconnect"> 이 사업에서만 이슈를 삭제합니다.<br>
                    <input id="delete-modal-select2" type="radio" name="delete-issue" value="delete"> 다른 모든 사업에서 이슈를 삭제합니다 (이슈를 완전히 제거함). 
                </form>
            </div>
            <div class="modal-footer">
                <button id="delete-modal-cancel" type="button" class="btn btn-default" data-dismiss="modal">취소</button>
                <button id="delete-modal-confirm" type="button" class="btn btn-primary">확인</button>
            </div>
        </div>
    </div>
</div>  

<div class="modal fade" id="auth-modal" tabindex="-1" role="dialog" aria-labelledby="authModelLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 id="auth-modal-title" class="modal-title" id="authModelLabel">로그인 또는 가입하기</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <form id="signin-form" role="form">
                            <h2 class="form-signin-heading">로그인</h2>
                            <div class="form-group">
                                <label for="signinEmail">이메일 주소 입력</label>
                                <input type="email" name="signinEmail" class="form-control" placeholder="Email address">
                            </div>
                            <div class="form-group">
                                <label for="signinPassword">패스워드 입력</label>
                                <input type="password" name="signinPassword" class="form-control" placeholder="Password">
                            </div>        

                        </form>
                        <div id="signin-fail" class="alert alert-danger" role="alert" style="display:none">잘못된 입력입니다..</div>
                    </div>
                    <div class="col-md-6">

                        <form id="register-form" role="form">
                            <h2 class="form-signup-heading"><small>또는</small> 가입하기</h2>
                            <div class="form-group">
                                <label for="registerEmail">이메일 주소 입력</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" id="registerEmail" name="registerEmail" placeholder="Enter Email" required>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-asterisk"></span></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="registerNickname">닉네임 입력</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="registerNickname" id="registerNickname" placeholder="Enter Name" required>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-asterisk"></span></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="registerPassword">패스워드 입력</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="registerPassword" name="registerPassword" placeholder="Input Password" required>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-asterisk"></span></span>
                                </div>
                            </div>
                        </form>
                        <div id="register-fail" class="alert alert-danger" role="alert" style="display:none">잘못된 입력입니.</div>
                        <div id="register-success" class="alert alert-info" role="alert" style="display:none">잘못된 입력입니.</div>
                    </div>  
                </div>         
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group btn-group-justified">      
                            <div class="btn-group">          
                                <button id="btn-signin" class="btn btn-large btn-primary" type="submit">Sign in</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group btn-group-justified">      
                            <div class="btn-group">          
                                <button id="btn-register" class="btn btn-large btn-success" type="submit">Register</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
