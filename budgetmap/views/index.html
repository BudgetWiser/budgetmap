<html>
<head>
    <title>{{title}}</title>


    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/treemap.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/barchart.css">
    <link rel="stylesheet" type="text/css" href="/libraries/bootstrap-3.2.0-dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/libraries/jquery-ui-1.11.0.custom/jquery-ui.min.css">

    <script type="text/javascript" src="/libraries/colorbrewer.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="/libraries/jquery-ui-1.11.0.custom/jquery-ui.min.js"></script> 
    
    <script type="text/javascript" src="/libraries/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/libraries/bootstrap-typeahead/bootstrap3-typeahead.min.js"></script>

    <!--<script type="text/javascript" src="/javascripts/issue.js"></script>-->
    <script type="text/javascript" src="/javascripts/treemap.js"></script>
    <script type="text/javascript" src="/javascripts/barchart.js"></script>
    <script type="text/javascript">
        var selected_budget = null;
        var selected_issue  = null;
        var issues = null, all_issues = null;
        var curr_year = 2014;
        var treemap = null, barchart = null;
        $(document).ready(function(){
            initialize();

            $.getJSON('/issues', function(data){
                all_issues = issues = data;
                displayIssues(data);
                setAutocomplete(all_issues);

            });

            $.getJSON('/budgets', function(data){
                treemap = new TreeMap();
                treemap.generate({
                    container : "#budget-chart",
                    size :  { width: 550, height: 700},
                    margin : { top: 0, left: 0, bottom: 0, right: 0},
                    data : data.budget,
                    onSelect: function(d){
                        deselectBudget();
                        issues = all_issues;
                        displayIssues(issues);

                        $("#service-chart").empty();
                        $("#service-chart-title").text(d.name+" 관련 사업목록");
                        services = data.services[d.name];
                        //console.log(services);
                        barchart = new BarChart();
                        barchart.generate({
                            container : "#service-chart",
                            size :  { width: 250, height: 700},
                            margin: {top: 10, right: 0, bottom: 0, left: 0},
                            margin2: {top: 20, right: 10, bottom: 0, left: 0},
                            data : services,
                            onSelect: function(d){
                                selectBudget(d);
                                $.getJSON('/issues/'+d._id, function(data){
                                    //console.log(data);
                                    issues = data;
                                    displayIssues(issues);
                                });
                                
                            },
                            onDeselect: function(d){
                                deselectBudget();
                                issues = all_issues;
                                displayIssues(issues);
                            }
                        });                        
                    },
                    onDeselect: function(d) {
                        $("#service-chart").empty();
                        deselectBudget();
                        issues = all_issues;
                        displayIssues(issues);
                    }
                });
            });
            $('#left-content').resize(function(){
                var elem = $(this);
                console.log('w, h = ' + elem.width() + ', ' + elem.height());
            });
            $('#new-issue').keypress(function(event) { return event.keyCode != 13; });
            $('#btn-new_issue').click(addIssue)

        });

        // $(window).resize(function(){
        //     var elem = $(this);
        //     console.log('w, h = ' + elem.width() + ', ' + elem.height());
        // });
        function initialize(){
            $( "#new-issue-fail" ).hide();
            $( "#new-issue-success" ).hide();
            deselectBudget();
        }
        function selectBudget(d){
            selected_budget = d;
            $('#issue-title').text(d.service);
        }
        function deselectBudget(){
            selected_budget = null;
            $('#issue-title').text("2014년 서울시 전체 예산");           
        }
        function addIssue(){

            var issue_name = $('#new-issue').val();

            if (issue_name==""){//no issue name provided
                console.log("no issue name provided")
                $( "#new-issue-fail" ).text("이슈가 입력되지 않았습니다.").show().effect( "shake" ).delay(1000).fadeOut();
                return;
            }
            var issue = null;
            for (var i in all_issues){
                if (all_issues[i].name == issue_name){
                    issue = all_issues[i];
                    break;
                }
            }

            if (issue!=null){ //update an existing issue
                //console.log(selected_budget);
                if (selected_budget==null || selected_budget.issues.indexOf(issue._id)!=-1){
                    $( "#new-issue-fail" ).text("이미 등록된 이슈가 있습니다.").show().effect( "shake" ).delay(1000).fadeOut();
                    return;
                }else{
                    issue.budgets.push(selected_budget._id);
                    createIssueElem(issue);
                    $.post("/issues/"+issue._id, 
                        {
                            budgets: issue.budgets
                        }); 
                    selected_budget.issues.push(issue._id)
                    //console.log(selected_budget.issues);
                    $.post("budgets/"+selected_budget._id,
                        {
                            issues: selected_budget.issues
                        });
                }                    
            }else{//create a new issue
                $.post("/issues", {
                    name: issue_name,
                    year: curr_year,
                    budgets: selected_budget==null? []:[selected_budget._id]
                }, function(res){   
                    issue = res.result[0];            
                    issues.push(issue);
                    all_issues.push(issue);
                    createIssueElem(issue);
                    if (selected_budget!=null){//connect budget on creation
                        selected_budget.issues.push(issue._id)
                        $.post("budgets/"+selected_budget._id, {
                            issues: selected_budget.issues
                        })
                    }
                    //update autocomplete names
                    setAutocomplete(all_issues);
                })

            }
            $('#new-issue').val(""); 
            $( "#new-issue-success" ).text("이슈가 성공적으로 등록되었습니다.").show().delay(1000).fadeOut();       
        }
        function setAutocomplete(issues){
            var source = [];
            for (var i in issues){
                source.push(issues[i].name);
            }
            $('#new-issue').typeahead('destroy')
            $('#new-issue').typeahead({source: source, highlight: true});
        }
        function displayIssues(data){
            $('#issue-list').empty();
            for (var i in data){
                createIssueElem(data[i]);
            }
        }
        function createIssueElem(issuse){
            $('#issue-list').append('<a href="#" class="list-group-item">'+issuse.name+'<span class="badge">관련사업: '+issuse.budgets.length+'개</span></a>');
        }
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">BudgetMap</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#">About</a>
                    </li>
                    <li>
                        <a href="#">Services</a>
                    </li>
                    <li>
                        <a href="#">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>    
    <div class="container">

        <div class="row">
            <!-- VISUALIZATION -->
            <div class="col-md-9">
                <div class="row">
                    <div class="col-lg-12">
                        <h3 class="page-header" style="margin-top:0px;">2014년도 서울시 전체 예산
                            <small> - 서울시 사업 예산과 관련된 이슈를 공유해 보세요!</small>
                        </h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div id="budget-chart" style="float:left"></div>
                    </div>
                    <div class="col-md-4" style="padding-left:0px;">
                        <h4 id="service-chart-title" style="margin:0px;"></h4> 
                        <div id="service-chart" style="width:280px;height:700px;overflow: auto;"></div>
                    </div>  
                </div>
            </div>             
            <!-- ISSUE AREA -->
            <div class="col-md-3">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 id="issue-title" class="panel-title"></h3>
                    </div>
                    <div class="panel-body">
                        <div class="jumbotron" style="padding: 10px;">
                            <h4 style="margin-top:2px; margin-bottom:5px; padding:0px"><span class="glyphicon glyphicon-pencil btn-lg"></span> 사회이슈 공유하기</h4>
                            <div id="new-issue-form" style="display:hidden;">
                                <div class="input-group"  style="width:100%">
                                    <input id="new-issue" data-provide="typeahead" type="text" class="form-control" placeholder="연관된 사회이슈를 입력 해주세요." style="width:100%" autocomplete="off">
                                </div>
                                <br/>
                                <div class="btn-group btn-group-justified">
                                    <div class="btn-group">
                                        <button id="btn-new_issue" type="button" class="btn btn-success">제출</button>
                                    </div>
                                    <!--<div class="btn-group">
                                        <button type="button" class="btn btn-default">취소</button>
                                    </div>-->
                                </div>
                            </div>
                            <div id="new-issue-fail" class="alert alert-danger" role="alert" style="display:hidden">이슈를 올바르게 입력해주세요.</div>
                            <div id="new-issue-success" class="alert alert-success" role="alert" style="display:hidden">이슈를 추가하였습니다.</div>
                        </div>
                    </div>
                    <h4 class="page-header text-muted text-center" style="margin-top:0px;">
                        연관 사회이슈
                    </h4>
                    <div id="issue-list" class="list-group">
                    </div>
                    <div class="text-center">
                        <ul class="pagination">
                            <li class="disabled"><a href="#">&laquo;</a></li>
                            <li class="active"><a href="#">1</a></li>
                            <li><a href="#">2</a></li>
                            <li><a href="#">3</a></li>
                            <li><a href="#">4</a></li>
                            <li><a href="#">5</a></li>
                            <li><a href="#">&raquo;</a></li>
                        </ul> 
                    </div>
                </div> 
            </div>
        </div>


    </div>
</div>
</body>
</html>
